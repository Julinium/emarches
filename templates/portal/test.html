<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Tender Winner Simulator</title>
        <style>
            body {font-family: Arial, sans-serif; max-width: 900px; margin: 2rem auto; padding: 1rem;}
            h1 {text-align:center;}
            .section {margin-bottom: 2rem; padding: 1rem; border:1px solid #ccc; border-radius:8px;}
            .candidate {display:flex; align-items:center; margin:0.5rem 0; padding:0.4rem; background:#f9f9f9; border-radius:4px;}
            .candidate.eliminated {background:#ffe6e6; opacity:0.6;}
            .candidate.winner {background:#e6ffe6; font-weight:bold;}
            .candidate input[type=text] {width:120px; margin-right:8px;}
            .candidate input[type=range] {flex:1; margin:0 8px;}
            .candidate .value {width:80px; text-align:right; margin: 8px;}
            .btn {margin-right:0.5rem; padding:0.4rem 0.8rem;}
            #results {font-size:1.1rem; line-height:1.8;}
            .highlight {color:#d00; font-weight:bold;}
        </style>
    </head>
    <body>

        <h1>Tender Winner Simulator</h1>

        <div class="section">
            <label>Tender Estimate E: <input id="estimate" type="number" step="0.01" value="100"></label>
        </div>

        <div class="section" id="candidates">
            <button class="btn" id="addCandidate">+ Add Candidate</button>
            <div id="candidateList"></div>
        </div>

        <div class="section" id="results"></div>

        <script>
            /* ---------- DATA & HELPERS ---------- */
            const candidates = [];               // {id, nameInp, slider, valSpan, bid, eliminated}
            let candidateIdCounter = 0;

            /* ---------- UI CREATION ---------- */
            function createCandidateRow() {
            const id = ++candidateIdCounter;
            const row = document.createElement('div');
            row.className = 'candidate';
            row.dataset.id = id;

            // name
            const nameInp = document.createElement('input');
            nameInp.type = 'text';
            nameInp.placeholder = 'Candidate name';
            nameInp.value = `Offer ${id}`;
            row.appendChild(nameInp);

            // value display
            const valSpan = document.createElement('span');
            valSpan.className = 'value';
            row.appendChild(valSpan);

            // slider
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.step = 0.01;
            row.appendChild(slider);

            // delete button
            const delBtn = document.createElement('button');
            delBtn.textContent = '×';
            delBtn.onclick = () => {
                row.remove();
                candidates.splice(candidates.findIndex(c=>c.id===id),1);
                recalc();
            };
            row.appendChild(delBtn);

            // store
            candidates.push({id, nameInp, slider, valSpan, bid:0, eliminated:false});
            document.getElementById('candidateList').appendChild(row);

            // listeners
            slider.addEventListener('input', () => updateCandidate(id, Number(slider.value)));
            nameInp.addEventListener('change', recalc);
            return row;
            }

            /* ---------- SLIDER LIMITS ---------- */
            function updateSliderLimits() {
            const E = Number(document.getElementById('estimate').value) || 0;
            const min = E * 0.8;
            const max = E * 1.2;

            candidates.forEach(c => {
                c.slider.min = min;
                c.slider.max = max;

                // clamp current value
                const cur = Number(c.slider.value);
                if (cur < min) c.slider.value = min;
                if (cur > max) c.slider.value = max;
                c.bid = Number(c.slider.value);
                c.valSpan.textContent = formatMoney(c.bid);
            });
            }

            /* ---------- CANDIDATE UPDATE ---------- */
            function updateCandidate(id, newBid) {
            const c = candidates.find(x=>x.id===id);
            if (!c) return;
            c.bid = newBid;
            c.valSpan.textContent = formatMoney(newBid);
            recalc();
            }

            /* ---------- CALCULATION ---------- */
            function recalc() {
            const E = Number(document.getElementById('estimate').value) || 0;
            const lower = E * 0.8;
            const upper = E * 1.2;

            const accepted = [];

            // 1. filter & mark eliminated
            for (const c of candidates) {
                const bid = c.bid;
                const eliminated = bid < lower || bid > upper;
                c.eliminated = eliminated;
                const row = document.querySelector(`.candidate[data-id="${c.id}"]`);
                row.classList.toggle('eliminated', eliminated);
                if (!eliminated) accepted.push(bid);
            }

            // 2. mean M
            let M = 0;
            if (accepted.length) M = accepted.reduce((a,b)=>a+b,0) / accepted.length;

            // 3. reference R
            const R = 0.5 * (E + M);

            // 4. winner (closest from below, else smallest above)
            let winnerBid = null;
            let winnerDiff = Infinity;
            let winnerBelow = false;

            for (const bid of accepted) {
                const diff = Math.abs(bid - R);
                const below = bid <= R;

                if (below) {
                if (diff < winnerDiff || (diff === winnerDiff && !winnerBelow)) {
                    winnerBid = bid; winnerDiff = diff; winnerBelow = true;
                }
                } else if (!winnerBelow && diff < winnerDiff) {
                winnerBid = bid; winnerDiff = diff; winnerBelow = false;
                }
            }

            // highlight
            document.querySelectorAll('.candidate').forEach(r=>r.classList.remove('winner'));
            if (winnerBid !== null) {
                const winnerCand = candidates.find(c=>c.bid===winnerBid && !c.eliminated);
                if (winnerCand) {
                document.querySelector(`.candidate[data-id="${winnerCand.id}"]`).classList.add('winner');
                }
            }

            // ----- DISPLAY -----
            const res = document.getElementById('results');
            const fmt = n => `<span class="highlight">${formatMoney(n)}</span>`;

            //  let html = `<strong>Estimate E:</strong> ${fmt(E)}<br>`;
            let html = ``;
            html += `<strong>Range (±20 %):</strong> ${fmt(lower)} – ${fmt(upper)}<br>`;
            //  html += `<strong>Accepted (${accepted.length}):</strong> ${accepted.map(fmt).join(', ') || '—'}<br>`;
            html += `<strong>Mean M:</strong> ${fmt(M)} ----- `;
            html += `<strong>Reference R:</strong> ${fmt(R)}<br>`;

            if (winnerBid !== null) {
                const wc = candidates.find(c=>c.bid===winnerBid && !c.eliminated);
                const name = wc ? wc.nameInp.value : '';
                html += `<strong>Winner:</strong> ${name} – ${fmt(winnerBid)}`;
                html += winnerBid <= R ? ' (closest from below)' : ' (smallest above)';
            } else {
                html += `<strong>Winner:</strong> —`;
            }
            res.innerHTML = html;
            }

            /* ---------- UTILITIES ---------- */
            function formatMoney(n) {
            return new Intl.NumberFormat('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}).format(n);
            }

            /* ---------- INITIALISATION ---------- */
            document.getElementById('addCandidate').onclick = () => {
            createCandidateRow();
            updateSliderLimits();   // set correct min/max for the new slider
            recalc();
            };

            const estimateInput = document.getElementById('estimate');
            estimateInput.addEventListener('input', () => {
            updateSliderLimits();
            recalc();
            });

            // start with 3 candidates
            for (let i=0;i<3;i++) {
            createCandidateRow();
            }
            updateSliderLimits();   // apply limits to the initial rows
            // set example bids inside the new range
            candidates.forEach((c,i) => {
            const example = (c.slider.min * 1) + (i * (c.slider.max - c.slider.min) / 4);
            c.slider.value = example;
            updateCandidate(c.id, example);
            });
            recalc();
        </script>

    </body>
</html>