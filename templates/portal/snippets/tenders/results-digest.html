{% load i18n l10n %}
{% load groupify humanize %}


<div id="participations">
    <div class="mt-4 mb-1 small">
        <span><i class="bi bi-building-up me-1"></i></span>
        <span class="">{% trans 'Participations' %}</span>
        <span class="">({{ tender.openings.last.bidders.all|length }})</span>
    </div>
    <div class="ms-3">
        {% for bidder in tender.openings.last.bidders.all %}
            <a href="{% url 'insights_bidder_details' bidder.id %}" 
                target="_blank" class="btn btn-sm btn-outline-secondary me-1 mb-2">
                <span class="">{% if show_bidders_names %}{{ bidder.name }}{% else %}{{ bidder.pseudo }}{% endif %}</span>
            </a>
        {% empty %}
            <div class="list-group small">
                <div class="list-group-item p-2">
                    {% trans 'None' %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<div id="admin-rejects">
    {% group_lots tender.openings.last.admin_rejects as grouped_ad_rej %}
    <div class="mt-4 mb-1 small">
        <span><i class="bi bi-fast-forward me-1"></i></span>
        <span class="">{% trans 'Admin Rejects' %}</span>
    </div>
    <div class="list-group small ms-3">
        {% for concurrent, lots in grouped_ad_rej.items %}
            <div class="list-group-item p-2 list-group-item-action">
                <span class="text-danger">{% if show_bidders_names %}{{ concurrent.name }}{% else %}{{ concurrent.pseudo }}{% endif %}</span>
                {% if tender.lots_count > 1 %}
                    <span class="float-end ms-2 ">
                        <span class="fw-light">{% trans 'Lots' %}: </span> 
                        <span>
                            {% for lot in lots %}
                                <span class="text-danger fw-bold small">{{ lot }}</span>{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </span>
                    </span>
                {% endif%}
            </div>
        {% empty %}
        <div class="list-group-item p-2 text-secondary fw-light">{% trans 'None' %}</div>
        {% endfor %}
    </div>
</div>    

<div id="admin-accepts">
    {% group_lots tender.openings.last.admin_accepts as grouped_ad_acc %}
    <div class="mt-4 mb-1 small">
        <span><i class="bi bi-fast-forward me-1"></i></span>
        <span class="">{% trans 'Admin Accepts' %}</span>
    </div>
    <div class="list-group small ms-3">
        {% for concurrent, lots in grouped_ad_acc.items %}
            <div class="list-group-item p-2 list-group-item-action">
                <span>{% if show_bidders_names %}{{ concurrent.name }}{% else %}{{ concurrent.pseudo }}{% endif %}</span>
                {% if tender.lots_count > 1 %}
                    <span class="float-end ms-2 ">
                        <span class="fw-light">{% trans 'Lots' %}: </span> 
                        <span>
                            {% for lot in lots %}
                                {{ lot }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </span>
                    </span>
                {% endif%}
            </div>
        {% empty %}
        <div class="list-group-item p-2 text-secondary fw-light">{% trans 'None' %}</div>
        {% endfor %}
    </div>
</div>

<div id="admin-reserves">
    {% group_lots tender.openings.last.admin_reserves as grouped_ad_res %}
    <div class="mt-4 mb-1 small">
        <span><i class="bi bi-fast-forward-circle me-1"></i></span>
        <span class="">{% trans 'Admin Reserves' %}</span>
    </div>
    <div class="list-group small ms-3">
        {% for concurrent, lots in grouped_ad_res.items %}
            <div class="list-group-item p-2 list-group-item-action">
                <span>{% if show_bidders_names %}{{ concurrent.name }}{% else %}{{ concurrent.pseudo }}{% endif %}</span>
                {% if tender.lots_count > 1 %}
                    <span class="float-end ms-2">
                        <span class="fw-light">{% trans 'Lots' %}: </span> 
                        <span>
                            {% for lot in lots %}
                                {{ lot }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </span>
                    </span>
                {% endif%}
            </div>
        {% empty %}
        <div class="list-group-item p-2 text-secondary fw-light">{% trans 'None' %}</div>
        {% endfor %}
    </div>
</div>

<div id="tech-rejects">
    {% if tender.openings.last.has_tech %}
        {% group_lots tender.openings.last.tech_rejects as grouped_te_rej %}
        <div class="mt-4 mb-1 small">
            <span><i class="bi bi-x-octagon me-1"></i></span>
            <span class="">{% trans 'Tech Rejects' %}</span>
        </div>
        <div class="list-group small ms-3">
            {% for concurrent, lots in grouped_te_rej.items %}
                <div class="list-group-item p-2 list-group-item-action">
                    <span class="text-danger">{% if show_bidders_names %}{{ concurrent.name }}{% else %}{{ concurrent.pseudo }}{% endif %}</span>
                    {% if tender.lots_count > 1 %}
                        <span class="float-end ms-2">
                            <span class="fw-light">{% trans 'Lots' %}: </span> 
                            <span>
                                {% for lot in lots %}
                                    {{ lot }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </span>
                        </span>
                    {% endif%}
                </div>
            {% empty %}
            <div class="list-group-item p-2 text-secondary fw-light">{% trans 'None' %}</div>
            {% endfor %}
        </div>
    {% endif %}
</div>

<div id="fin-offers">
    <div class="mt-4 mb-1 small">
        <span><i class="{{ bicons.estimate }} me-1"></i></span>
        <span class="">{% trans 'Financial Offers' %}</span>
    </div>
    {% if tender.openings.last.selected_bids|length > 0 %}
        {% for group in tender.openings.last.selected_bids|group_by:"lot_number" %}
            <div class="list-group small ms-3 mb-2">
                <div class="list-group-item p-2 disabled bg-secondary-subtle">
                    <div class="row">
                        <div class="col-12 col-md-6">
                            {% if tender.lots_count > 1 %}
                                <span class="fw-light">{% trans 'Lot' %}</span>
                                <span class="">{{ group.lot_number }}</span>
                                <span class="small"><i class="bi bi-three-dots-vertical text-secondary"></i></span>
                            {% endif%}
                            <span class="fw-light">E=<span class="fw-bold">{{ group.amzgaro.lot.estimate }}</span></span>
                            <span class="small"><i class="bi bi-three-dots-vertical text-secondary"></i></span>

                            <span class="fw-light me-2">{% trans 'Offers' %}:<span class="fw-bold">{{ group.amzgaro.composits|length }}</span></span>
                        </div>
                        {% if group.qahnsen|length > 1 %}
                            <div class="col-12 col-md-6 text-end">
                                <span class="fw-light text-primary ms-2" >M=<span class="fw-bold">{{ group.amzgaro.average|floatformat:2 }}</span></span>
                                <span class="small"><i class="bi bi-three-dots-vertical text-secondary me-1"></i></span>
                                <span class="fw-light text-success float-end" >R=<span class="fw-bold">{{ group.amzgaro.optimum|floatformat:2 }}</span></span>
                            </div>
                        {% endif %}
                    </div>
                    {% if group.qahnsen|length > 1 %}
                        <div id="bars" class="">
                            {% if group.amzgaro.lot.estimate %}
                                <div class="progress bg-light py-0 mt-1"
                                        style="height: 0.2rem;">
                                    <div class="progress-bar bg-secondary" 
                                            role="progressbar" style="width: 50%;" 
                                            aria-valuenow="50" aria-valuemin="0" 
                                            aria-valuemax="100">
                                    </div>
                                </div>
                            {% endif %}
                            
                            {% if group.amzgaro.lot.estimate and group.amzgaro.average %}
                                {% progrefy group.amzgaro.lot.estimate group.amzgaro.average as avg_bar %}
                                <div class="progress bg-light py-0 mt-1"
                                        style="height: 0.2rem;">
                                    <div class="progress-bar bg-primary" 
                                            role="progressbar" style="width: {{ avg_bar|unlocalize }}%;" 
                                            aria-valuenow="{{ avg_bar|unlocalize }}" aria-valuemin="0" 
                                            aria-valuemax="100">
                                    </div>
                                </div> 
                            {% endif %}                   
                            
                            {% if group.amzgaro.lot.estimate and group.amzgaro.optimum %}
                                {% progrefy group.amzgaro.lot.estimate group.amzgaro.optimum as ref_bar %}
                                <div class="progress bg-light py-0 mt-1"
                                        style="height: 0.2rem;">
                                    <div class="progress-bar bg-success" 
                                            role="progressbar" style="width: {{ ref_bar|unlocalize }}%;" 
                                            aria-valuenow="{{ ref_bar|unlocalize }}" aria-valuemin="0" 
                                            aria-valuemax="100">
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                </div>
                {% for selected_bid in group.qahnsen %}
                    <div class="list-group-item p-2 list-group-item-action">
                        <div class="row">
                            <div class="col-12 col-md-6">
                                <span class="{% if selected_bid.winner %} text-success fw-bold{% endif %}">
                                    {% if show_bidders_names %}{{ selected_bid.concurrent.name }}{% else %}{{ selected_bid.concurrent.pseudo }}{% endif %}
                                </span>
                            </div>
                            <div class="col-12 col-md-6 text-end">
                                {% if selected_bid.amount_a != selected_bid.amount_b %}
                                    <span class="small fw-light text-decoration-line-through ms-1">{{ selected_bid.amount_b }}</span>
                                {% endif %}
                                {% if selected_bid.winner %}
                                    <span class="small"><i class="{{ bicons.winner }} small text-success text-success"></i></span>
                                {% endif %}
                                {% if group.qahnsen|length > 1 %}
                                    <span class="badge{% if selected_bid.winner == true %} fw-light{% else %} fw-bold{% endif %} text-secondary bg-secondary-subtle">E {% if selected_bid.offset >= 0 %}+{% endif %}{{ selected_bid.offset|floatformat:1|default:'?' }}%</span>
                                    <span class="badge{% if selected_bid.winner == true %} fw-light{% else %} fw-bold{% endif %} text-success bg-success-subtle">R {% if selected_bid.score >= 0 %}+{% endif %}{{ selected_bid.score|floatformat:2|default:'?' }}</span>
                                {% endif %}
                                <span class="float-end ms-2">{{ selected_bid.amount_a }}</span>
                            </div>
                        </div>
                        {% if group.qahnsen|length > 1 %}
                            <div class="">
                                {% if group.amzgaro.lot.estimate and selected_bid.amount_a %}
                                    {% progrefy group.amzgaro.lot.estimate selected_bid.amount_a as bid_bar %}
                                    <div class="progress bg-secondary-subtle py-0 mt-1"
                                            style="height: 0.1rem;">
                                        <div class="progress-bar bg-warning" 
                                                role="progressbar" style="width: {{ bid_bar|unlocalize }}%;" 
                                                aria-valuenow="{{ bid_bar|unlocalize }}" aria-valuemin="0" 
                                                aria-valuemax="100">
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                {% empty %}
                    <div class="list-group small ms-3">
                        <div class="list-group-item p-2 text-danger fw-light">{% trans 'None' %}</div>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    {% else %}
        <div class="list-group small ms-3">
            <div class="list-group-item p-2 text-secondary fw-light">{% trans 'None' %}</div>
        </div>
    {% endif %}
</div>

<div id="winner-bids">
    <div class="mt-4 mb-1 small">
        <span><i class="{{ bicons.winner }} me-1"></i></span>
        <span class="">{% trans 'Awards' %}</span>
    </div>
    <div class="list-group small ms-3">
        {% for winner_bid in tender.openings.last.winner_bids %}
            <div class="list-group-item p-2 list-group-item-action">
                <span class="{% if tender.lots_count < 2 %} d-none{% endif%}">
                    <span class="fw-light">{% trans 'Lot' %}</span>
                    <span class="">{{ winner_bid.lot_number }}:</span>
                </span>
                <span class="text-success fw-bold">
                    {% if show_bidders_names %}{{ winner_bid.concurrent.name }}{% else %}{{ winner_bid.concurrent.pseudo }}{% endif %}
                </span>
                <span class="float-end ms-2 fw-bold">{{ winner_bid.amount_w }}</span>
            </div>
        {% empty %}
        <div class="list-group-item p-2 text-secondary fw-light">{% trans 'None' %}</div>
        {% endfor %}
    </div>
</div>

<div id="win-justifs">
    <div class="mt-4 mb-1 small">
        <span><i class="bi bi-question-square me-1"></i></span>
        <span class="">{% trans 'Selection Justification' %}</span>
    </div>
    <div class="list-group small ms-3">
        {% for win_justif in tender.openings.last.win_justifs %}
            <div class="list-group-item p-2 list-group-item-action">
                {% if tender.lots_count > 1 %}
                    <span class="">
                        <span class="fw-light">{% trans 'Lot' %}</span>
                        <span class="">{{ win_justif.lot_number }}:</span>
                    </span>
                {% endif%}
                <span class="">{{ win_justif.justif }}</span>
            </div>
        {% empty %}
        <div class="list-group-item p-2 text-secondary fw-light">{% trans 'None' %}</div>
        {% endfor %}
    </div>
</div>

<div id="meta-info">
    <div class="row gx-3 gy-1 mt-2 small">
        {% trans 'Date Finished' as key_value %}
        {% include 'base/snippets/ico-key-val.html' with id_value=tender.openings.last.id|add:'0' val_value=tender.openings.last.date key_value=key_value uni_value='' ico_class=bicons.published val_class='' border='bottom' liner='' %}
        {% trans 'Unsuccessful declaration' as key_value %}
        {% include 'base/snippets/ico-key-val.html' with id_value=tender.openings.last.id|add:'1' val_value=tender.openings.last.failure key_value=key_value uni_value='' val_class='' border='bottom' liner='' %}
    </div>
</div>

