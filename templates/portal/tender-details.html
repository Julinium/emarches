{% extends 'base/base.html' %}
{% load i18n static %}
{% load paraminos %}
{% load humanize %}
{% load tz %}

{% block title %}
    {% trans "Tenders Details" %}
{% endblock title %}

{% block content %}
    <h3>{% trans "Tenders Details" %}</h3>

    {% if tender.cancelled %}
        <div class="my-3" id="tender-cancelled-top" >
            <div class="text-bg-danger rounded text-center my-2">
                <div class="fw-bold p-1">
                    {% trans 'CANCELLED' %}
                </div>
            </div>
        </div>
    {% endif %}

    {% if tender.expired %}
        <div class="my-3" id="tender-expired-top" >
            <div class="text-bg-secondary rounded text-center my-2">
                <div class="fw-bold p-1">
                    {% trans 'EXPIRED' %}
                </div>
            </div>
        </div>
    {% endif %}

    <div class="my-3" id="tender-details">
        <div class="row gx-4 gy-0">

            {% trans 'Object' as key_value %}
            {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-title' val_value=tender.title key_value=key_value uni_value='' ico_class=bicons.title full_width='yes' val_class='fw-bold' border='bottom' liner='threelines' %}
            
            {% trans 'Public Client' as key_value %}
            {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-client' val_value=tender.client.name key_value=key_value uni_value='' ico_class=bicons.client full_width='yes' val_class='' border='bottom' liner='oneline' %}

            {% trans 'Time to Deadline' as key_value %}
            {% trans 'days' as unit %}
            {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-days_to_go' val_value=tender.days_to_go key_value=key_value uni_value=unit ico_class=bicons.days_to_go val_class='' border='bottom' liner='oneline' %}
            
            {% timezone "Africa/Casablanca" %}
                {% trans 'Deadline' as key_value %}
                {% trans 'Morocco time' as unit %}
                {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-deadline' val_value=tender.deadline key_value=key_value uni_value=unit ico_class=bicons.deadline val_class='fw-bold' border='bottom' liner='oneline' %}
            {% endtimezone %}

            <div class="col-12 mb-3">
                <div class="progress bg-danger p-0 mx-0 my-1" 
                     style="max-height: 0.5rem;"
                     data-bs-toggle="tooltip"
                     title="{% trans 'Bidding deadline' %}: {{ tender.deadline }}">
                    {% with tender.days_to_go|progrefy:full_bar_days as green %}
                        <div class="progress-bar bg-success" 
                             role="progressbar" style="width: {{ green }}%;" 
                             aria-valuenow="{{ green }}" aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    {% endwith %}
                </div>
            </div>

            {% trans 'Total Estimate' as key_value %}
            {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-estimate' val_value=tender.estimate key_value=key_value uni_value='' ico_class=bicons.estimate val_class='fw-bold' border='bottom' liner='oneline' %}
            
            {% trans 'Total Guarantee' as key_value %}
            {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-bond' val_value=tender.bond key_value=key_value uni_value='' ico_class=bicons.bond val_class='' border='bottom' liner='oneline' %}
            
            {% trans 'Reference' as key_value %}
            {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-reference' val_value=tender.reference key_value=key_value uni_value='' ico_class=bicons.reference val_class='' border='bottom' liner='oneline' %}
            
            {% trans 'Published' as key_value %}
            {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-published' val_value=tender.published key_value=key_value uni_value='' ico_class=bicons.published val_class='' border='bottom' liner='oneline' %}

            {% trans 'Main Category' as key_value %}
            {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-category' val_value=tender.category.label key_value=key_value uni_value='' ico_class=bicons.category val_class='' border='bottom' liner='oneline' %}

            {% trans 'Execution Location' as key_value %}
            {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-location' val_value=tender.location key_value=key_value uni_value='' ico_class=bicons.location val_class='' border='bottom' liner='oneline' %}
            </div>

            <div id="collapseAdvanced" class="collapse">
                <div class="row gx-4 gy-0">
                    {% trans 'Procedure' as key_value %}
                    {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-procedure' val_value=tender.procedure.name key_value=key_value uni_value='' ico_class=bicons.procedure val_class='' border='bottom' liner='' %}

                    {% trans 'Awarding Mode' as key_value %}
                    {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-mode' val_value=tender.mode.name key_value=key_value uni_value='' ico_class=bicons.mode val_class='' border='bottom' liner='' %}

                    {% trans 'Electronic bidding' as key_value %}
                    {% with translated_value="" %}
                        {% if tender.ebid == 1 %}
                            {% trans 'Required' as translated_value %}
                        {% elif tender.ebid == 0 %}
                            {% trans 'Optional' as translated_value %}
                        {% else %}
                            {% trans 'Not Applicable' as translated_value %}
                        {% endif %}
                        {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-ebid' val_value=translated_value key_value=key_value uni_value='' ico_class=bicons.ebid val_class='' border='bottom' liner='' %}
                    {% endwith %}

                    {% trans 'Electronic signature' as key_value %}
                    {% with translated_value="" %}
                        {% if tender.esign == 1 %}
                            {% trans 'Required' as translated_value %}
                        {% elif tender.esign == 0 %}
                            {% trans 'Optional' as translated_value %}
                        {% else %}
                            {% trans 'Not Applicable' as translated_value %}
                        {% endif %}
                        {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-esign' val_value=translated_value key_value=key_value uni_value='' ico_class=bicons.esign val_class='' border='bottom' liner='' %}
                    {% endwith %}

                    {% trans 'Reserved to SMBs, individuals, Unions, ...' as key_value %}
                    {% with translated_value="" %}
                        {% if tender.reserved %}
                            {% trans 'Yes' as translated_value %}
                        {% else %}
                            {% trans 'No' as translated_value %}
                        {% endif %}
                        {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-reserved' val_value=translated_value key_value=key_value uni_value='' ico_class=bicons.reserved_ico val_class='' border='bottom' liner='' %}
                    {% endwith %}

                    {% trans 'Variants accepted' as key_value %}
                    {% with translated_value="" %}
                        {% if tender.variant %}
                            {% trans 'Yes' as translated_value %}
                        {% else %}
                            {% trans 'No' as translated_value %}
                        {% endif %}
                        {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-variant' val_value=translated_value key_value=key_value uni_value='' ico_class=bicons.variant_ico val_class='' border='bottom' liner='' %}
                    {% endwith %}

                    {% if tender.plans_price > 0 %}
                        {% trans 'Price of Plans' as key_value %}
                        {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-plans_price' val_value=tender.plans_price key_value=key_value uni_value='' ico_class=bicons.plans_price val_class='' border='bottom' liner='' %}
                    {% endif %}

                    {% if tender.domains.all %}
                        {% trans 'Domains of activity' as key_value %}
                        {% include 'base/snippets/ico-key-list.html' with id_value=tender.chrono|add:'-domain' items=tender.domains.all key_value=key_value uni_value='' full_width='yes' ico_class=bicons.domains val_class='small' border='bottom' liner='' %}
                    {% endif %}

                    {% if tender.lots.count == 1 %}
                        {% if tender.has_agrements %}
                            {% trans 'Required Licences' as agrements_caption %}
                            {% include 'portal/snippets/tenders/qu-ag.html' with caption=agrements_caption objects=tender.lots.first.agrements.all kind='agrement' ico_class=bicons.agrements_ico val_class='small' border='bottom' liner='' %}
                        {% endif %}

                        {% if tender.has_qualifs %}
                            {% trans 'Required Qualifications' as qualifs_caption %}
                            {% include 'portal/snippets/tenders/qu-ag.html' with caption=qualifs_caption objects=tender.lots.first.qualifs.all kind='qualif' ico_class=bicons.qualifs_ico val_class='small' border='bottom' liner='' %}
                        {% endif %}

                        {% timezone "Africa/Casablanca" %}
                            {% trans 'Morocco time' as unit %}
                            {% if tender.has_samples %}
                                {% trans 'Required Samples' as samples_caption %}
                                {% include 'portal/snippets/tenders/qu-ag.html' with caption=samples_caption|add:' - '|add:unit objects=tender.lots.first.samples.all kind='sample' ico_class=bicons.samples_ico val_class='small' border='bottom' liner='' %}
                            {% endif %}

                            {% if tender.has_meetings %}
                                {% trans 'Scheduled Meetings' as meetings_caption %}
                                {% include 'portal/snippets/tenders/qu-ag.html' with caption=meetings_caption|add:' - '|add:unit objects=tender.lots.first.meetings.all kind='meeting' ico_class=bicons.meetings_ico val_class='small' border='bottom' liner='' %}
                            {% endif %}

                            {% if tender.has_visits %}                    
                                {% trans 'Scheduled Visits' as visits_caption %}
                                {% include 'portal/snippets/tenders/qu-ag.html' with caption=visits_caption|add:' - '|add:unit objects=tender.lots.first.visits.all kind='visit' ico_class=bicons.visits_ico val_class='small' border='bottom' liner='' %}
                            {% endif %}
                        {% endtimezone %}
                    {% endif %}

                    {% trans 'Withdrawal, Bidding & Awarding addresses' as key_value %}
                    {% include 'base/snippets/ico-key-list.html' with id_value=tender.chrono|add:'-address' items=addresses key_value=key_value uni_value='' full_width='yes' ico_class=bicons.address val_class='small' border='bottom' liner='' %}
                    
                    <div class="col-12">
                        <div class="d-flex my-3">
                            <div>
                                <i class="{{ bicons.contact }}"></i>
                            </div>
                            <div class="ms-2 w-100 border-0 border-bottom">
                                <div class="text-muted small fw-light">
                                    {% trans 'Public Client Contact' %}
                                </div>
                                <div class="" id="public-contact">
                                    {% if tender.contact_name and tender.contact_name != '-' %}
                                        <span class="me-1 mb-1 small">{{ tender.contact_name }}</span>
                                    {% endif %}
                                    {% if tender.contact_phone and tender.contact_phone != '-' %}
                                        <span class="me-1 small">
                                            <a href="tel:{{ tender.contact_phone }}" 
                                            class="btn btn-sm mb-1 btn-outline-secondary">
                                                <i class="bi bi-telephone"></i>
                                                {{ tender.contact_phone }}
                                            </a>
                                        </span>
                                    {% endif %}
                                    {% if tender.contact_email and tender.contact_email != '-' %}
                                        <span class="me-1 small">
                                            <a href="mailto:{{ tender.contact_email }}" 
                                            class="btn btn-sm mb-1 btn-outline-secondary">
                                                <i class="bi bi-envelope"></i>
                                                {{ tender.contact_email }}
                                            </a>
                                        </span>
                                    {% endif %}
                                    {% if tender.contact_fax and tender.contact_fax != '-' %}
                                        <span class="me-1 small">
                                            <a href="tel:{{ tender.contact_fax }}" 
                                            class="btn btn-sm mb-1 btn-outline-secondary">
                                                <i class="bi bi-printer"></i>
                                                {{ tender.contact_fax }}
                                            </a>
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    {% timezone "UTC" %}
                        {% trans 'Created' as key_value %}
                        {% trans 'UTC' as unit %}
                        {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-created' val_value=tender.created key_value=key_value uni_value=unit ico_class=bicons.created val_class='text-muted small' border='bottom' liner='' %}
                    {% endtimezone %}
                    
                    {% timezone "UTC" %}
                        {% trans 'UTC' as unit %}
                        {% trans 'Last updated' as key_value %}
                        {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-updated' val_value=tender.updated key_value=key_value uni_value=unit ico_class=bicons.updated val_class='text-muted small' border='bottom' liner='' %}
                    {% endtimezone %}

                    {% trans 'Time on display' as key_value %}
                    {% trans 'days' as uni_value %}
                    {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-days_span' val_value=tender.days_span key_value=key_value uni_value=uni_value ico_class=bicons.days_span val_class='text-muted small' border='bottom' liner='' %}
                    
                    {% trans 'Database ID' as key_value %}
                    {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-id' val_value=tender.id key_value=key_value uni_value='' ico_class=bicons.hash val_class='text-muted small' border='bottom' liner='' %}
                    

                    {% trans 'Views' as key_value %}
                    {% with count=tender.views.all|length|metrify:0 %}
                        {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-views' val_value=count key_value=key_value uni_value='' ico_class=bicons.views val_class='text-muted small' border='bottom' liner='' %}
                    {% endwith %}
                    {% if tender.views.all %}
                        {% trans 'Latest view since' as key_value %}
                        {% with latest=tender.views.first.when|timesince %}
                            {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-latest' val_value=latest key_value=key_value uni_value='' ico_class=bicons.history val_class='text-muted small' border='bottom' liner='' %}
                        {% endwith %}
                    {% endif %}

                    {% trans 'Downloads' as key_value %}
                    {% with count=tender.downloads.all|length|metrify:0 %}
                        {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-downloads' val_value=count key_value=key_value uni_value='' ico_class=bicons.downloads val_class='text-muted small' border='bottom' liner='' %}
                    {% endwith %}
                    {% if tender.downloads.all %}
                        {% trans 'Latest download since' as key_value %}
                        {% with latest=tender.downloads.first.when|timesince %}
                            {% include 'base/snippets/ico-key-val.html' with id_value=tender.chrono|add:'-latest' val_value=latest key_value=key_value uni_value='' ico_class=bicons.history val_class='text-muted small' border='bottom' liner='' %}
                        {% endwith %}
                    {% endif %}

                    {% if tender.changes.all %}                
                        <div class="col-12">
                            <div class="d-flex my-3">
                                <div>
                                    <i class="{{ bicons.changes }}"></i>
                                </div>
                                <div class="ms-2 w-100 border-0 border-bottom">
                                    <div class="text-muted small fw-light">
                                        {% trans 'Tender Changes' %}
                                    </div>
                                    <div class="small">
                                        {% for change in tender.changes.all  %}
                                            <div class="mt-2">
                                                <span class=""
                                                    data-bs-toggle="tooltip"
                                                    title="{% trans 'Reported' %}: {{ change.reported }}">
                                                    — {{ change.reported|date }}:
                                                </span>
                                                <span class="">
                                                    {% for mod in change.changes|dictify %}
                                                        <span class="ms-2" data-bs-toggle="tooltip" 
                                                            title="{{ mod.old_value|default:'-' }} &#10230; {{ mod.new_value|default:'-' }}">
                                                            <i class="bi bi-bezier2 small"></i>
                                                            <span>{{ mod.field }}</span>
                                                        </span>
                                                    {% endfor %}
                                                </span><br>
                                            </div>
                                        {% empty %}
                                            <span class="fw-light small text-muted mt-2">{% trans 'Not found' %}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if tender.cancelled %}
        <div class="my-3" id="tender-cancelled-bottom" >
            <div class="text-bg-danger rounded text-center my-2">
                <div class="fw-bold p-1">
                    {% trans 'CANCELLED' %}
                </div>
            </div>
        </div>
    {% endif %}

    <div class="my-3" id="tender-actions" >
        <div class="text-center">

            <a class="m-1 btn btn-outline-secondary collapsed" 
                    type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapseAdvanced" 
                    aria-expanded="false" aria-controls="collapseAdvanced">
                <span class=""><i class="bi bi-list-columns-reverse"></i></span>
                <span class="ms-1">{% translate "Advanced View" %}</span>
            </a>

            {% if tender.lots_count > 1 %}
                <span>
                    <button type="button" class="m-1 btn btn-outline-primary" 
                            data-bs-toggle="modal" data-bs-target="#t{{ tender.chrono }}m">
                        <span class="fw-bold">{{ tender.lots_count }}</span>
                        <span><i class="{{ bicons.multi_lots }}"></i></span>
                        <span class="ms-1">{% trans "Lots details" %}</span>
                        
                    </button>
                    <span class="text-start">
                        {% include 'portal/snippets/lots/lots-details.html' with chrono=tender.chrono lots=tender.lots.all %}
                    </span>
                </span>
            {% endif %}
            {% if files_info|length == 1 and not dce_modal %}
                {% with files_info|first as f %}
                    <a href="{% url 'portal_tender_get_file' tender.id f.name %}"
                            class="m-1 btn btn-outline-primary" type="button">
                        <span class="fw-bold">{{ total_size|filesizeformat }}</span>
                        <span><i class="{{ bicons.downloads }}"></i></span>
                        <span class="ms-1">{% trans 'Download' %}</span>
                    </a>
                {% endwith %}
            {% else %}
                
                <button class="m-1 btn btn-outline-primary" type="button" 
                        data-bs-toggle="modal" data-bs-target="#dceModal">
                    <span><i class="{{ bicons.downloads }}"></i></span>
                    <span class="ms-1 fw-bold">{{ total_size|filesizeformat }}</span>
                    <span class="ms-1">{% trans 'Download' %}</span>
                </button>

                <div id="dceModal" class="modal fade" tabindex="-1" aria-labelledby="dceModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="dceModalLabel">{% translate "Tender's files" %}</h1>
                            </div>
                            <div class="modal-body">

                                {% if files_info  %}
                                    <!-- <hr class="my-1"> -->
                                    <div class="small text-muted my-2">{% translate "Once you click on an item, your browser or device should handle the download process." %}</div>
                                    {% for f in files_info %}
                                        <a id="dce-{{ forloop.counter }}"
                                        class="text-decoration-none w-100 btn btn-outline-primary text-start mt-2" 
                                        href="{% url 'portal_tender_get_file' tender.id f.name %}">
                                            <span class=""><i class="{{ bicons.downloads }}"></i></span>
                                            <span class="ms-1 badge text-bg-primary">{{ f.size|filesizeformat }}</span>
                                            <span class="ms-1">{{ f.name }}</span>
                                            {% if files_info|length == 1 %}
                                                <script>
                                                    document.getElementById('dce-{{ forloop.counter }}').addEventListener('click', () => {
                                                        bootstrap.Modal.getInstance(document.getElementById('dceModal')).hide();
                                                        document.getElementById('dceModal').classList.toggle('show');
                                                    });
                                                </script>
                                            {% endif %}
                                        </a>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-danger">{% translate "Sorry. We could not get the files for this Tender." %}</div>
                                    <div class="small text-muted">{% translate "Please try again later, or contact us if this problem persists." %}</div>
                                    <div class="mt-2">
                                        <a href="/base_contact" target="_blank" class="btn btn-outline-primary mt-2">
                                            <span><i class="bi bi-send"></i></span>
                                            <span class="ms-1">{% translate 'Contact Us' %}</span>
                                        </a>
                                    </div>
                                {% endif %}

                            </div>
                            <div class="modal-footer">
                                <a href="/base_legal'" target="_blank" class="btn btn-outline-secondary">
                                    <span><i class="bi bi-shield-exclamation"></i></span>
                                    <span class="ms-1">{% translate 'Legal Information' %}</span>
                                </a>
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <span><i class="bi bi-x-lg"></i></span>
                                    <span class="ms-1">{% translate 'Close' %}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
            
            <!-- Start Favorite toggle -->
            <!-- <a href="javascript:" class="m-1 btn btn-outline-primary">{% trans 'Bookmark' %}</a> -->
            <!-- <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> -->
            <!-- Favorite Button -->
            <!-- <button id="favorite-btn"
                    class="btn {% if is_favorited %}btn-danger{% else %}btn-success{% endif %}"
                    data-tender-pk="{{ tender.pk }}"
                    data-bs-toggle="modal"
                    data-bs-target="#favoriteModal">
                {% if is_favorited %}
                    {% trans "Remove from Favorites" %}
                {% else %}
                    {% trans "Add to Favorites" %}
                {% endif %}
            </button> -->

            <!-- Modal Form -->
            <div class="modal fade" id="favoriteModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <form id="favorite-form">
                            {% csrf_token %}
                            <div class="modal-header">
                            <h5 class="modal-title">{% trans "Add to Favorites" %}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                            <input type="hidden" name="action" value="add">

                            <div class="mb-3">
                                <label class="form-label">{% trans "Company" %}</label>
                                <div id="company-container">
                                <!-- Filled by JS -->
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">{% trans "Folders" %}</label>
                                <div id="folder-container">
                                <!-- Filled by JS -->
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">{% trans "Comment (optional)" %}</label>
                                <textarea name="comment" class="form-control" rows="2"></textarea>
                            </div>
                            </div>
                            <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                {% trans "Cancel" %}
                            </button>
                            <button type="submit" class="btn btn-primary">
                                {% trans "Save" %}
                            </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <script>
                $(function () {
                    const $btn   = $('#favorite-btn');
                    const $modal = $('#favoriteModal');
                    const $form  = $('#favorite-form');

                    // -------------------------------------------------
                    // Load companies / folders (once)
                    // -------------------------------------------------
                    function loadChoices() {
                        $.getJSON("{% url 'company_folder_choices' %}", function (data) {
                            const compHtml = data.companies.map(c =>
                                `<div class="form-check">
                                <input class="form-check-input" type="checkbox" name="company" value="${c.id}" id="c${c.id}">
                                <label class="form-check-label" for="c${c.id}">${c.name}</label>
                                </div>`
                            ).join('');
                            $('#company-container').html(compHtml);

                            const folderHtml = data.folders.map(f =>
                                `<div class="form-check">
                                <input class="form-check-input" type="checkbox" name="folders" value="${f.id}" id="f${f.id}">
                                <label class="form-check-label" for="f${f.id}">${f.name}</label>
                                </div>`
                            ).join('');
                            $('#folder-container').html(folderHtml);
                        });
                    }

                    // -------------------------------------------------
                    // Button click
                    // -------------------------------------------------
                    $btn.on('click', function (e) {
                        if ($btn.hasClass('btn-danger')) {
                            // ---- REMOVE ----
                            if (confirm('{% trans "Remove from favorites?" %}')) {
                                $.post({
                                    url: "{% url 'favorite_toggle' tender.pk %}",
                                    data: { action: 'remove', csrfmiddlewaretoken: $form.find('input[name=csrfmiddlewaretoken]').val() },
                                    success: function (resp) {
                                        if (resp.status === 'removed') {
                                            $btn.removeClass('btn-danger').addClass('btn-success')
                                                .text('{% trans "Add to Favorites" %}');
                                        }
                                    }
                                });
                            }
                            e.preventDefault();               // stop modal
                        } else {
                            // ---- ADD / EDIT ----
                            if (!$('#company-container').children().length) loadChoices();
                        }
                    });

                    // -------------------------------------------------
                    // Form submit – ONE LINE serialize()
                    // -------------------------------------------------
                    $form.on('submit', function (e) {
                        e.preventDefault();

                        $.post({
                            url: "{% url 'favorite_toggle' tender.pk %}",
                            data: $form.serialize(),               // <-- includes csrf_token
                            success: function (resp) {
                                if (resp.status === 'added' || resp.status === 'updated') {
                                    $modal.modal('hide');
                                    $btn.removeClass('btn-success').addClass('btn-danger')
                                        .text('{% trans "Remove from Favorites" %}');
                                } else {
                                    alert('Error: ' + JSON.stringify(resp.errors));
                                }
                            },
                            error: function () {
                                alert('Server error');
                            }
                        });
                    });
                });
                </script>


            <!-- End Favorite toggle -->

            <a target="_blank"
               href="{{ link_prefix }}{{ tender.link }}"
               class="m-1 btn btn-outline-primary">
                <span><i class="{{ bicons.bidding }}"></i></span>
                <span class="ms-1">{% trans 'Bid' %}</span>
            </a>
            <!--
                Modal :
                We don't handle bidding process automatically.
                We can provide paid support separately (eSign, preparation, ...).
                Go to portal: Good luck.
                Contact us: $200 and if won: +1.5%
            -->
        </div>
    </div>

{% endblock content %}
