{% extends 'base/base.html' %}
{% load i18n static %}
{% load paraminos %}
{% load humanize %}
{% load tz %}

{% block title %}
    {% trans "Tenders Simulator" %}
{% endblock title %}

{% block content %}

    <div class="d-flex justify-content-between align-items-center">
        <div>
            <span class="h3">{% trans "Tenders Simulator" %}</span>
        </div>
    </div>

    <div class="my-3" id="tender-details">
        <div>
            <div class="card shadow-sm mb-2 bg-secondary-subtle">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="my-1 mx-2">E=<span class="fw-bold">{{ e_est }}</span></div>
                    <div class="my-1 mx-2 text-end small">T=+/- {{ e_slo }}%</div>
                </div>
            </div>
            <!-- <div class="card shadow-sm mb-2 bg-secondary-subtle">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="my-1 mx-2 small">{{ e_min }}<</div>
                    <div class="my-1 mx-2 small text-end">>{{ e_max }}</div>
                </div>
            </div> -->
            <div class="card shadow-sm mb-2 bg-secondary-subtle">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="my-1 mx-2 small">M=<span id="spanMean"></span></div>
                    <div class="my-1 mx-2 small text-end">R=<span class="fw-bold" id="spanReference"></span></div>
                </div>
            </div>
            <div class="card shadow-sm mb-2 bg-success-subtle text-center">
                <div>
                    <span class="fw-bold small">WINNER = </span>
                    <span id="winnerValue" class="text-success fw-bold fs-5"></span>
                    <!-- <span id="winnerExplain" class="small ms-1"></span> -->
                </div>
            </div>

            <!-- <div id="results" class="mb-2"></div> -->
             <div class="mt-3 mb-2">Bidding Offers</div>
            <div id="candidateList" class="ms-3"></div>
            <button class="btn btn-outline-primary" id="addCandidate">+ Add Offer</button>
        </div>
    </div>


    <script>
            /* ---------- DATA & HELPERS ---------- */
            const candidates = [];               // {id, nameInp, slider, valSpan, bid, eliminated}
            let candidateIdCounter = 0;
            const Esti = Number({{ eEst|safe }});
            const Emin = Number({{ eMin|safe }});
            const Emax = Number({{ eMax|safe }});

            const offerStrings = {{ offers|safe }};
            console.log(offerStrings);
            // const allOffers = offerStrings.map(s => Number(s));
            // console.log(allOffers);


            /* ---------- UI CREATION ---------- */
            function createCandidateRow(initial_bid=0) {
                const id = ++candidateIdCounter;
                const card = document.createElement('div');
                card.className = 'candidate card shadow-sm mb-2 p-2';
                card.dataset.id = id;

                const divTop = document.createElement('div');
                card.appendChild(divTop);

                const btnSpan = document.createElement('span');
                divTop.appendChild(btnSpan);

                // delete button
                const delBtn = document.createElement('button');
                delBtn.className = 'btn p-0';
                delBtn.onclick = () => {
                    card.remove();
                    candidates.splice(candidates.findIndex(c=>c.id===id),1);
                    recalc();
                };
                const delIco = document.createElement('i');
                delIco.className = 'bi bi-trash small';
                delBtn.appendChild(delIco);

                btnSpan.appendChild(delBtn);

                // name
                const nameInp = document.createElement('span');
                nameInp.type = 'text';
                nameInp.value = `OFFER #${id}`;
                nameInp.className = 'small mx-1';
                nameInp.textContent = `OFFER #${id} :`;
                btnSpan.appendChild(nameInp);

                // value display
                const valSpan = document.createElement('span');
                console.log('initial_bid =', initial_bid)
                // const valVal = Number(initial_bid);
                // console.log('valVal =', valVal);
                valSpan.className = 'value ms-1';
                // valSpan.textContent = Number({{ initial_bid|safe }});
                valSpan.textContent = initial_bid;
                // valSpan.textContent = valVal;
                btnSpan.appendChild(valSpan);
                // updateCandidate(id, Number(initial_bid));

                // slider
                const slider = document.createElement('input');
                slider.type = 'range';
                slider.step = 0.01;
                slider.min = Emin;
                slider.max = Emax;
                // slider.value = Number(initial_bid);
                slider.value = initial_bid;
                slider.className = 'mt-1';
                card.appendChild(slider);

                // store
                candidates.push({id, nameInp, slider, valSpan, bid:Number(initial_bid)});
                document.getElementById('candidateList').appendChild(card);

                // listeners
                slider.addEventListener('input', () => updateCandidate(id, Number(slider.value)));
                nameInp.addEventListener('change', recalc);
                return card;
            }

            /* ---------- SLIDER LIMITS ---------- */
            // function updateSliderLimits() {
            //     const E = Number(document.getElementById('estimate').value) || 0;
            //     const min = E * 0.8;
            //     const max = E * 1.2;

            //     candidates.forEach(c => {
            //         c.slider.min = min;
            //         c.slider.max = max;

            //         // clamp current value
            //         const cur = Number(c.slider.value);
            //         if (cur < min) c.slider.value = min;
            //         if (cur > max) c.slider.value = max;
            //         c.bid = Number(c.slider.value);
            //         c.valSpan.textContent = formatMoney(c.bid);
            //     });
            // }

            /* ---------- CANDIDATE UPDATE ---------- */
            function updateCandidate(id, newBid) {
                const c = candidates.find(x=>x.id===id);
                if (!c) return;
                c.bid = newBid;
                c.valSpan.textContent = formatMoney(newBid);
                recalc();
            }

            /* ---------- CALCULATION ---------- */
            function recalc() {
                const E = Esti//Number(document.getElementById('estimate').value) || 0;
                const lower = Emin // E * 0.8;
                const upper = Emax //E * 1.2;

                const accepted = [];

                // 1. filter & mark eliminated
                for (const c of candidates) {
                    const bid = c.bid;
                    accepted.push(bid);
                }

                // 2. mean M
                let M = 0;
                if (accepted.length) M = accepted.reduce((a,b)=>a+b,0) / accepted.length;

                // 3. reference R
                const R = 0.5 * (E + M);
                const spanR = document.getElementById('spanReference');
                const spanM = document.getElementById('spanMean');

                if (spanM) spanM.textContent = formatMoney(M);
                if (spanR) spanR.textContent = formatMoney(R);

                // 4. winner (closest from below, else smallest above)
                let winnerBid = null;
                let winnerDiff = Infinity;
                let winnerBelow = false;

                for (const bid of accepted) {
                    const diff = Math.abs(bid - R);
                    const below = bid <= R;

                    if (below) {
                        if (diff < winnerDiff || (diff === winnerDiff && !winnerBelow)) {
                            winnerBid = bid; winnerDiff = diff; winnerBelow = true;
                    }
                    } else if (!winnerBelow && diff < winnerDiff) {
                        winnerBid = bid; winnerDiff = diff; winnerBelow = false;
                    }
                }

                // highlight
                const winnerClass = 'bg-success-subtle'
                document.querySelectorAll('.candidate').forEach(r=>r.classList.remove(winnerClass));
                if (winnerBid !== null) {
                    // const winnerCand = candidates.find(c=>c.bid===winnerBid);
                    // if (winnerCand) {
                    //     document.querySelector(`.candidate[data-id="${winnerCand.id}"]`).classList.add(winnerClass);
                    // }

                    const winnerCands = candidates.filter(c => c.bid === winnerBid);
                    winnerCands.forEach(winnerCand => {
                        const element = document.querySelector(`.candidate[data-id="${winnerCand.id}"]`);
                        if (element) {
                            element.classList.add(winnerClass);
                        }
                    });


                }

                // ----- DISPLAY -----
                // const res = document.getElementById('results');
                // const fmt = n => `<span class="highlight">${formatMoney(n)}</span>`;

                //  let html = `<strong>Estimate E:</strong> ${fmt(E)}<br>`;
                // let html = ``;
                // html += `<strong>Range (±20 %):</strong> ${fmt(lower)} – ${fmt(upper)}<br>`;
                //  html += `<strong>Accepted (${accepted.length}):</strong> ${accepted.map(fmt).join(', ') || '—'}<br>`;
                // html += `<strong>Mean M:</strong> ${fmt(M)} ----- `;
                // html += `<strong>Reference R:</strong> ${fmt(R)}<br>`;

                if (winnerBid !== null) {
                    const winnerVal = document.getElementById('winnerValue');
                    const winnerExp = document.getElementById('winnerExplain');
                    winnerVal.textContent = formatMoney(winnerBid);
                    // winnerExp.textContent = winnerBid <= R ? '(closest from below)' : '(smallest above)';
                    // winnerExp.textContent = winnerBid <= R ? '(Below R)' : '(Above R)';

                    // const wc = candidates.find(c=>c.bid===winnerBid);
                    // const name = wc ? wc.nameInp.value : '';
                    // html += `<strong>Winner:</strong> ${name} – ${fmt(winnerBid)}`;
                    // html += winnerBid <= R ? ' (closest from below)' : ' (smallest above)';
                } else {
                    // html += `<strong>Winner:</strong> —`;
                    winnerVal.textContent = '--';
                    // winnerExp.textContent = '--';
                }
                // res.innerHTML = html;
            }

            /* ---------- UTILITIES ---------- */
            function formatMoney(n) {
                return new Intl.NumberFormat('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}).format(n);
            }

            /* ---------- INITIALISATION ---------- */
            document.getElementById('addCandidate').onclick = () => {
                createCandidateRow(Esti);
                // updateSliderLimits();   // set correct min/max for the new slider
                recalc();
            };

            // const estimateInput = document.getElementById('estimate');
            // estimateInput.addEventListener('input', () => {
            //     updateSliderLimits();
            //     recalc();
            // });

            // start with 3 candidates
            // for (let i=0;i<3;i++) {
            //     createCandidateRow();
            // }for (const item of myList)
            // for (const offer of allOffers){
            //     console.log(offer);
            //     createCandidateRow(offer);
            // }

            offerStrings.forEach(offer => {
                // console.log(offer); 
                // const bid = Number({{ offer|safe }});
                // const bid = Number({{ offer|safe }});
                // console.log(offer); 

                const sanitized = String(offer).trim().replace(/[^\d.-]/g, '');
                const bid = Number(sanitized);
                createCandidateRow(bid);
            });

            // updateSliderLimits();   // apply limits to the initial rows
            // set example bids inside the new range
            // candidates.forEach((c,i) => {
            //     const example = (c.slider.min * 1) + (i * (c.slider.max - c.slider.min) / 4);
            //     c.slider.value = example;
            //     updateCandidate(c.id, example);
            // });
            recalc();
        </script>



{% endblock content %}
