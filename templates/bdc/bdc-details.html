{% extends 'base/base.html' %}
{% load i18n static %}
{% load humanize %}
{% load tz %}

{% block title %}
    {% trans "Purchase Order Details" %}
{% endblock title %}

{% block content %}
    <input type="hidden" id="csrf_token" value="{{ csrf_token }}">

    <div class="d-flex justify-content-between align-items-center">
        <div>
            <span id="pinned" class="me-2 p-2 badge text-bg-success {% if not pinned %}d-none{% endif %}">
                <span class="">
                    <i class="{{ bicons.pinned }}"></i>
                    <span class="d-none d-md-inline">{% trans "FAVORITED" %}</span>
                </span>
            </span>
            <span class="h3">{% trans "Purchase Order Details" %}</span>
        </div>
    </div>

    {% if not bdc.expired %}
        <div class="col-12 mb-3">
            <div class="progress bg-danger p-0 mx-0 my-1" 
                style="max-height: 0.2rem;"
                data-bs-toggle="tooltip"
                title="{% trans 'Bidding deadline' %}: {{ bdc.deadline }}">
                {% with bdc.days_to_go|barify:full_bar_days as green %}
                    <div class="progress-bar bg-success" 
                        role="progressbar" style="width: {{ green }}%;" 
                        aria-valuenow="{{ green }}" aria-valuemin="0" 
                        aria-valuemax="100">
                    </div>
                {% endwith %}
            </div>
        </div>
    {% endif %}

    {% if bdc.expired %}
        <div class="my-3" id="bdc-expired-top" >
            <div class="text-bg-secondary rounded text-center my-2">
                <div class="fw-bold p-1">
                    <span><i class="{{ bicons.expired }} me-1"></i></span>
                    <span>{% trans 'EXPIRED' %}</span>
                </div>
            </div>
        </div>
    {% endif %}

    {% include 'bdc/snippets/bdcs/bdc-actions.html' %}

    <div class="my-3" id="bdc-details">

        <div class="row gx-4 gy-0">
            
            {% trans 'Object' as key_value %}
            {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-title' val_value=bdc.title key_value=key_value uni_value='' ico_class=bicons.title full_width='yes' val_class='fw-bold' border='bottom' liner='threelines' %}
        
            {% timezone "Africa/Casablanca" %}
                {% trans 'Deadline' as key_value %}
                {% trans 'Morocco time' as unit %}
                {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-deadline' val_value=bdc.deadline key_value=key_value uni_value=unit ico_class=bicons.deadline val_class=ddl_classes border='bottom' liner='oneline' %}
            {% endtimezone %}
            
            {% trans 'Time to Deadline' as key_value %}
            {% trans 'days' as unit %}
            {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-days_to_go' val_value=bdc.days_to_go key_value=key_value uni_value=unit ico_class=bicons.days_to_go val_class=ddl_classes border='bottom' liner='oneline' %}

            {% trans 'Reference' as key_value %}
            {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-reference' val_value=bdc.reference key_value=key_value uni_value='' ico_class=bicons.reference val_class='' border='bottom' liner='oneline' %}
            
            {% timezone "UTC" %}
                {% trans 'Published' as key_value %}
                {% trans 'UTC' as unit %}
                {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-published' val_value=bdc.published key_value=key_value uni_value=unit ico_class=bicons.published val_class='' border='bottom' liner='oneline' %}
            {% endtimezone %}
            
            {% trans 'Category' as key_value %}
            {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-category' val_value=bdc.category.label key_value=key_value uni_value='' ico_class=bicons.category val_class='' border='bottom' liner='oneline' %}

            {% trans 'Execution Location' as key_value %}
            {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-location' val_value=bdc.location key_value=key_value uni_value='' ico_class=bicons.location val_class='fw-bold' border='bottom' liner='oneline' %}

            {% trans 'Public Client' as key_value %}
            {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-client' val_value=bdc.client.name key_value=key_value uni_value='' ico_class=bicons.client full_width='yes' val_class='' border='bottom' liner='twolines' %}

             {% if bdc.nature %}
                {% trans 'Nature of service' as key_value %}
                {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-nature' val_value=bdc.nature key_value=key_value uni_value='' ico_class=bicons.nature full_width='yes' val_class='' border='bottom' liner='twolines' %}
            {% endif %}
            
        </div>

        
        {% if bdc.expired %}
            <div id="results" class="row gx-4">
                {% if bdc.deliberated %}

                    {% timezone "Africa/Casablanca" %}
                        {% trans 'Results published' as key_value %}
                        {% trans 'Morocco time' as unit %}
                        {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-deliberated' val_value=bdc.deliberated key_value=key_value uni_value=unit ico_class=bicons.deliberated val_class='' border='bottom' liner='oneline' %}
                    {% endtimezone %}

                    {% trans 'Candidates' as key_value %}
                    {% trans 'Bids received' as unit %}
                    {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-bids_count' val_value=bdc.bids_count key_value=key_value uni_value=unit ico_class=bicons.count val_class='fw-bold' border='bottom' liner='oneline' %}
                            
                    
                    {% if bdc.unsuccessful == True %}

                        {% trans 'Result' as key_value %}
                        {% trans 'UNSUCCESSFUL' as val_value %}
                        {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-unsuccess' val_value=val_value key_value=key_value uni_value='' ico_class=bicons.unsuccessful val_class='fw-bold text-danger' border='bottom' liner='oneline' %}

                    {% elif bdc.unsuccessful == False %}

                        {% trans 'Winner amount' as key_value %}
                        {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-winner_amount' val_value=bdc.winner_amount key_value=key_value uni_value='' ico_class=bicons.estimate val_class='fw-bold text-success' border='bottom' liner='oneline' %}

                        {% trans 'Winner entity' as key_value %}
                        {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-winner_entity' val_value=bdc.winner_entity key_value=key_value uni_value='' ico_class=bicons.winner val_class='fw-bold text-success' border='bottom' liner='oneline' %}

                    {% else %}

                        {% trans 'Result' as key_value %}
                        {% trans 'Unknown' as val_value %}
                        {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-unknown' val_value=val_value key_value=key_value uni_value='' ico_class='bi bi-check-circle' val_class='fw-bold text-secondary' border='bottom' liner='oneline' %}

                    {% endif %}

                {% else %}
                    {% trans 'Awarding' as key_value %}
                    {% trans 'No results found' as no_results %}
                    {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-results' val_value=no_results key_value=key_value uni_value='' ico_class=bicons.deliberated val_class='fw-bold text-danger' border='bottom' liner='oneline' %}
                {% endif %}
            </div>
        {% endif %}



        {% if bdc.articles.all %}

            <div class="accordion my-3" id="accordionItems">
                <div class="accordion-item shadow-sm">
                    <h2 class="accordion-header">
                        <button class="accordion-button p-2 collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#itemsCollapse" aria-expanded="true" aria-controls="itemsCollapse">
                            <span><i class="{{ bicons.articles }}"></i></span>
                            <span class="fw-bold ms-1">{{ bdc.articles.all|length }}</span>
                            <span class="ms-2 fw-light">{% trans "Items Details" %}</span>
                        </button>
                    </h2>
                    <div id="itemsCollapse" class="accordion-collapse collapse" data-bs-parent="#accordionItems">
                        <div class="accordion-body p-0">
                            {% include "bdc/snippets/articles/articles-details-list.html" %}                            
                        </div>
                    </div>
                </div>
            </div>

            {% if show_export == 'yes' or show_print == 'yes' %}
                <div id="articles-details" class="text-end">
                    {% if show_export == 'yes' %}
                        <a href="{% url 'bdc_articles_csv' bdc.id csv_file_name  %}" 
                        class="mb-1 btn btn-outline-secondary">
                            <span><i class="bi bi-file-earmark-spreadsheet me-1"></i></span>
                            <span class="fw-bold">CSV</span>
                            <span class="d-none d-md-inline ms-1">{% trans "Export" %}</span>
                        </a>
                    {% endif %}
                    {% if show_print == 'yes' %}
                        <a href="{% url 'bdc_articles_pdf' bdc.id pdf_file_name %}" 
                        class="mb-1 btn btn-outline-secondary">                        
                            <span><i class="bi bi-file-earmark-pdf me-1"></i></span>
                            <span class="fw-bold">PDF</span>
                            <span class="d-none d-md-inline ms-1">{% trans "Print" %}</span>
                        </a>
                    {% endif %}
                </div>
            {% endif %}

        {% endif %}
        
        <div id="extra-details" class="small mt-3">
            <div class="row gx-4 gy-0">

                {% timezone "UTC" %}
                    {% trans 'Created' as key_value %}
                    {% trans 'UTC' as unit %}
                    {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-created' val_value=bdc.created key_value=key_value uni_value=unit  val_class='small' border='bottom' liner='oneline' %}
                {% endtimezone %}
                    
                {% timezone "UTC" %}
                    {% trans 'Updated' as key_value %}
                    {% trans 'UTC' as unit %}
                    {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-updated' val_value=bdc.updated key_value=key_value uni_value=unit val_class='small' border='bottom' liner='oneline' %}
                {% endtimezone %}

                {% trans 'ID' as key_value %}
                {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-id' val_value=bdc.id key_value=key_value uni_value=''  val_class='small' border='bottom' liner='oneline' %}
                            
                {% trans 'Display time' as key_value %}
                {% trans 'days' as unit %}
                {% include 'base/snippets/ico-key-val.html' with id_value=bdc.chrono|add:'-days_span' val_value=bdc.days_span key_value=key_value uni_value=unit|add:' Â±' val_class='small' border='bottom' liner='oneline' %}

            </div>
        </div>

    </div>

    {% include 'bdc/snippets/bdcs/bdc-actions.html' %}


    <div id="bdc-modals">
        <div id="dceModal" class="modal fade" tabindex="-1" aria-labelledby="dceModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="dceModalLabel">{% translate "Purchase Order files" %}</h1>
                    </div>
                    <div class="modal-body">

                        <div class="small text-muted my-2">{% translate "Once you click on an item, your browser or device should handle the download process." %}</div>
                        <div class="small text-danger my-2">{% translate "We do not host these files. We only provide a link to their original locations." %}</div>
                        {% for f in bdc.attachements.all %}
                            <a id="dce-{{ bdc.chrono }}000{{ forloop.counter }}"
                            class="text-decoration-none w-100 btn btn-outline-primary text-start mt-2" 
                            href="{{ f.link }}">
                                <span class=""><i class="{{ bicons.downloads }}"></i></span>
                                <span class="ms-1">{{ f.name }}</span>
                            </a>
                        {% empty %}
                            <div class="text-center mb-2">
                                <img class="img-fluid" style="max-height: 6rem;" src="{% static 'graphics/wheelbarrow.svg' %}" alt="X">
                            </div>
                            <div class="text-danger">{% translate "Files for this PO are not ready, yet." %}</div>
                            <div class="small text-muted">{% translate "Please try again later, or contact us if this problem persists." %}</div>
                        {% endfor %}

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <span><i class="bi bi-x-lg"></i></span>
                            <span class="ms-1">{% translate 'Close' %}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="tosts-container" class="toast-container bottom-0 end-0 p-3" style="position: fixed; z-index: 99;">
        
        <div class="toast bg-success-subtle " id="pinToast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
            <div class="d-flex  justify-content-between">
                <div class="toast-body alert-success">
                    <strong class="me-auto" id="pinToastHeader">
                        {% trans "Item Favorited successfully" %}.
                    </strong>
                </div>
                    <button type="button" class="btn-close me-2 m-2" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div> 

        <div class="toast bg-success-subtle " id="unpinToast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
            <div class="d-flex  justify-content-between">
                <div class="toast-body alert-success">
                    <strong class="me-auto" id="unpinToastHeader">
                        {% trans "Item Unfavorited successfully" %}.
                    </strong>
                </div>
                    <button type="button" class="btn-close me-2 m-2" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div> 

        <div class="toast bg-danger-subtle " id="failedToast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
            <div class="d-flex  justify-content-between">
                <div class="toast-body alert-danger">
                    <strong class="me-auto" id="failedToastHeader">
                        {% trans "Operation failed" %}. {% trans "Please refresh the page or try again later" %}.
                    </strong>
                </div>
                    <button type="button" class="btn-close me-2 m-2" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div> 

        <div class="toast bg-success-subtle " id="copyToast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
            <div class="d-flex  justify-content-between">
                <div class="toast-body alert-success">
                    <strong class="me-auto" id="copyToastHeader">
                        {% trans "URL copied to clipboard" %}.
                    </strong>
                </div>
                    <button type="button" class="btn-close me-2 m-2" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div> 

    </div>


    {% if bdc.attachements.all|length == 1 %}
        <script>
            document.getElementById('dce-{{ bdc.chrono }}0001').addEventListener('click', () => {
                bootstrap.Modal.getInstance(document.getElementById('dceModal')).hide();
                document.getElementById('dceModal').classList.toggle('show');
            });
        </script>
    {% endif %}



    <script>
        const azrems = document.querySelectorAll('.wait-azrem');
        
        function pinToggle(makas='pin') {
            azrems.forEach(azrem => { azrem.classList.remove('d-none'); });
            const token = document.getElementById('csrf_token').value;

            if (makas=='pin'){ url = "{% url 'bdc_bdc_stickies_add' bdc.id %}"
            } else { url = "{% url 'bdc_bdc_stickies_remove' bdc.id %}"}
            const xhr = new XMLHttpRequest();
            xhr.open('POST', url, true);
            xhr.setRequestHeader('X-CSRFToken', token);
            xhr.setRequestHeader('Accept', 'text/plain');
            const pin_indicator = document.getElementById('pinned')
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        const buttons = document.querySelectorAll('.pin-toggle');
                        buttons.forEach(button => { button.classList.toggle('d-none'); });
                        pin_indicator.classList.toggle('d-none');
                
                        if ( makas == 'pin' ) {
                            let pinToast = document.getElementById('pinToast');
                            let pinAlert = new bootstrap.Toast(pinToast);
                            pinAlert.show();
                        }
                        if ( makas == 'unpin' ) {
                            const unpinToast = document.getElementById('unpinToast');
                            const unpinAlert = new bootstrap.Toast(unpinToast);
                            unpinAlert.show();
                        }
                    } else {
                        let failedToast = document.getElementById('failedToast');
                        let failedAlert = new bootstrap.Toast(failedToast);
                        failedAlert.show();
                        // alert('Operation Failed !')
                    }
                    azrems.forEach(azrem => { azrem.classList.add('d-none'); });
                }
            };
            xhr.onerror = function () {
                console.error('Network error while saving Favorite record');
            };

            xhr.send();
        }
    </script>

    <script>
        function sharePage(host='https://www.emarches.com') {
            const bdc_id = "{{ bdc.id|escapejs }}"; 
            const baseUrl = `${host}/bdc/details/`;
            const fullUrl = baseUrl + bdc_id + "/";
            const title = document.title;

            if (navigator.share) {
                navigator.share({
                    title: title,
                    url: fullUrl
                })
                .then(() => console.log('Shared successfully'))
                .catch((error) => console.error('Error sharing:', error));
            } else {
                navigator.clipboard.writeText(fullUrl)
                    .then(() => {
                        var toastElement = document.getElementById('copyToast');
                        var toast = new bootstrap.Toast(toastElement);
                        toast.show();
                    })
                    .catch((error) => console.error('Error copying URL:', error));
            }
        }
    </script>

    <script>
        const toastEls = document.getElementsByClassName('alert-dismissible');
        if (toastEls) {
            for (let i = 0; i < toastEls.length; i++) {
                const toastEl = toastEls[i];
                if (!toastEl.classList.contains('alert-danger')){
                    const timeout = 5000 + 1000*i;
                    let timeoutId;
                    let startTime;
                    let remainingTime = timeout;

                    const handleMouseEnter = () => {
                    clearTimeout(timeoutId);
                    startTime = Date.now();
                    };

                    const handleMouseLeave = () => {
                    const elapsedTime = Date.now() - startTime;
                    remainingTime -= elapsedTime;

                    if (remainingTime > 0) {
                        timeoutId = setTimeout(() => {
                        toastEl.style.display = 'none';
                        }, remainingTime);
                    } else {
                        toastEl.style.display = 'none';
                    }
                    };

                    const updateTimerDisplay = (elt) => {
                        if (elt){
                            elt.style.width = "${remainingTime/timeout}%";
                        }
                    };


                    toastEl.addEventListener('mouseenter', handleMouseEnter);
                    toastEl.addEventListener('mouseleave', handleMouseLeave);

                    timeoutId = setTimeout(() => {
                    toastEl.style.display = 'none';
                    }, timeout);
                }
            }
        }
    </script>


{% endblock content %}
