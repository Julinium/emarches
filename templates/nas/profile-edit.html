{% extends 'authy/base-authy.html' %}
    {% load static i18n %}

{% block content %}
    <div class="h3">Edit Profile</div>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mt-3">
            <div class="text-center">
                <div id="img-preview" class="position-relative d-inline-block ratio ratio-1x1" style="max-width: 10rem;">
                    {% if form.instance.image %}
                        <img id="image-preview" src="{{ form.instance.avatar }}" alt="Avatar" class="img-fluid rounded-circle object-fit-cover">
                    {% else %}
                        <img id="image-preview" src="{% static 'avatars/default.png' %}" alt="Default avatar" class="img-fluid rounded-circle object-fit-cover">
                    {% endif %}
                    <div class="position-absolute bottom-0 start-50 translate-middle-x bg-dark bg-opacity-75 text-white py-3 w-100 rounded-3 shadow collapse" id="image-requirements">
                        <div class="small fw-light">
                            {% trans "Images (PNG, JPG, JPEG, GIF, WEBP), under 5MB. Preferably square." %}
                        </div>
                    </div>
                </div>
                <div id="img-actions" class="mt-2">
                    <input type="file" class="d-none" id="{{ form.image.id_for_label }}" name="{{ form.image.name }}" accept="image/*">
                    <input type="hidden" id="{{ form.clear_image.id_for_label }}" name="{{ form.clear_image.name }}" value="0">
                    <label for="{{ form.image.id_for_label }}" class="btn btn-sm btn-outline-primary" title="{% trans 'Upload Image' %}">
                        <i class="bi bi-image me-1"></i> {% trans 'Change' %}
                    </label>
                    <button type="button" 
                            class="btn btn-sm btn-outline-secondary" 
                            title="{% trans 'About' %}"
                            data-bs-toggle="collapse" 
                            data-bs-target="#image-requirements" 
                            aria-expanded="false" 
                            aria-controls="image-requirements"
                            >
                        <i class="bi bi-exclamation-circle"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" title="{% trans 'Clear Image' %}" id="clear-image"><i class="bi bi-trash me-1"></i>{% trans 'Clear' %}</button>
                </div>
            </div>
        </div>
        
        <div class="form-floating mt-3 d-none">
            <input type="text" class="form-control" id="{{ form.username.id_for_label }}" name="{{ form.username.name }}" value="{{ form.username.value }}" required>
            <label class="text-muted small fw-light" for="{{ form.username.id_for_label }}">{{ form.username.label }}</label>
        </div>
        <div class="form-floating mt-3">
            <input type="text" class="form-control" id="{{ form.first_name.id_for_label }}" name="{{ form.first_name.name }}" value="{{ form.first_name.value }}">
            <label class="text-muted small fw-light" for="{{ form.first_name.id_for_label }}">{{ form.first_name.label }}</label>
        </div>
        <div class="form-floating mt-3">
            <input type="text" class="form-control" id="{{ form.last_name.id_for_label }}" name="{{ form.last_name.name }}" value="{{ form.last_name.value }}">
            <label class="text-muted small fw-light" for="{{ form.last_name.id_for_label }}">{{ form.last_name.label }}</label>
        </div>
        <div class="form-floating mt-3">
            <input type="text" class="form-control" id="{{ form.phone.id_for_label }}" name="{{ form.phone.name }}" value="{{ form.phone.value }}">
            <label class="text-muted small fw-light" for="{{ form.phone.id_for_label }}">{{ form.phone.label }}</label>
        </div>
        <div class="form-floating mt-3">
            <input type="text" class="form-control" id="{{ form.whatsapp.id_for_label }}" name="{{ form.whatsapp.name }}" value="{{ form.whatsapp.value }}">
            <label class="text-muted small fw-light" for="{{ form.whatsapp.id_for_label }}">{{ form.whatsapp.label }}</label>
        </div>
        <div class="form-floating mt-3">
            <textarea class="form-control" id="{{ form.about.id_for_label }}" name="{{ form.about.name }}" style="height: 5rem;">{{ form.about.value }}</textarea>
            <label class="text-muted small fw-light" for="{{ form.about.id_for_label }}">{{ form.about.label }}</label>
        </div>

        <div class="mt-3">        
            <button type="submit" class="btn btn-primary">{% trans "Save" %}</button>
            <a class="btn btn-outline-secondary" href="{% url 'nas_profile_view' %}">Cancel</a>
        </div>
    </form>

    <script>
        const imageInput = document.getElementById('{{ form.image.id_for_label }}');
        const imagePreview = document.getElementById('image-preview');
        const clearButton = document.getElementById('clear-image');
        const clearImageInput = document.getElementById('{{ form.clear_image.id_for_label }}');
        const defaultImage = "{% static 'avatars/default.png' %}";

        imageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    clearImageInput.value = '0'; // Reset clear_image when a new file is selected
                };
                imageInput.value = reader.readAsDataURL(file);

            }
        });

        clearButton.addEventListener('click', function() {
            imagePreview.src = defaultImage; // Reset to default avatar
            clearImageInput.value = '1'; // Set clear_image to True
            imageInput.value = ''; // Clear the file input
        });
    </script>
{% endblock content %}